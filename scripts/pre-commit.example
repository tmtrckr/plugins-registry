#!/bin/sh
#
# Pre-commit hook example
# Copy this file to .git/hooks/pre-commit (without .example) to enable
#

# This hook validates plugin registry before commit
# It runs automatically when you commit changes to plugins/ or registry.json

# To install:
# cp scripts/pre-commit.example .git/hooks/pre-commit
# chmod +x .git/hooks/pre-commit

# Or use the install-hooks script:
# npm run install-hooks

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${GREEN}üîç Running pre-commit validation...${NC}\n"

# Check if plugins directory or registry.json changed
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "(plugins/|registry\.json)")

if [ -z "$CHANGED_FILES" ]; then
  echo "${GREEN}‚úÖ No plugin files changed, skipping validation${NC}"
  exit 0
fi

echo "${YELLOW}üìù Changed files:${NC}"
echo "$CHANGED_FILES" | sed 's/^/   /'
echo ""

# Check if node_modules exists
if [ ! -d "node_modules" ]; then
  echo "${YELLOW}‚ö†Ô∏è  node_modules not found, installing dependencies...${NC}"
  npm install --silent
fi

# Validate plugins
echo "${GREEN}üîç Validating plugin files...${NC}"
npm run validate-plugins
PLUGIN_VALIDATION=$?

if [ $PLUGIN_VALIDATION -ne 0 ]; then
  echo "\n${RED}‚ùå Plugin validation failed!${NC}"
  echo "${YELLOW}üí° Fix the errors above and try again${NC}"
  exit 1
fi

# Build registry
echo "\n${GREEN}üî® Building registry...${NC}"
npm run build
BUILD_STATUS=$?

if [ $BUILD_STATUS -ne 0 ]; then
  echo "\n${RED}‚ùå Registry build failed!${NC}"
  exit 1
fi

# Check if registry.json is staged
if git diff --cached --quiet registry.json 2>/dev/null; then
  echo "${GREEN}‚úÖ registry.json is not staged${NC}"
else
  # Check if only last_updated timestamp changed
  # Get the staged diff and check if it only contains last_updated changes
  STAGED_DIFF=$(git diff --cached registry.json)
  
  # Count lines that are actual content changes (not metadata lines)
  CONTENT_CHANGES=$(echo "$STAGED_DIFF" | grep -E "^[+-]" | grep -v "last_updated" | wc -l)
  
  if [ "$CONTENT_CHANGES" -eq 0 ]; then
    # Only last_updated changed - unstage it since CI will regenerate it
    echo "${YELLOW}‚ö†Ô∏è  registry.json only has timestamp changes (last_updated)${NC}"
    echo "${GREEN}üì¶ Unstaging registry.json (CI will regenerate it)${NC}"
    git restore --staged registry.json
  else
    # Actual plugin data changed - keep it staged
    echo "${GREEN}‚úÖ registry.json has actual changes and will be committed${NC}"
  fi
fi

echo "\n${GREEN}‚úÖ Pre-commit validation passed!${NC}"
exit 0
